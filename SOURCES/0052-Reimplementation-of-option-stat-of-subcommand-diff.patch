From e3f51ace41efab8ec6a172c8c65533ca69203ebe Mon Sep 17 00:00:00 2001
From: wuzhouhui <wuzhouhui250@gmail.com>
Date: Sun, 8 Oct 2017 11:35:58 +0800
Subject: [PATCH 52/95] Reimplementation of option --stat of subcommand diff

---
 subversion/include/svn_client.h | 23 +++++++++++
 subversion/libsvn_client/diff.c | 92 +++++++++++++++++++++++++++++++++++++++++
 subversion/svn/diff-cmd.c       | 43 +------------------
 subversion/svn/svn.c            |  2 +-
 4 files changed, 118 insertions(+), 42 deletions(-)

diff --git a/subversion/include/svn_client.h b/subversion/include/svn_client.h
index 088d237..72a827e 100644
--- a/subversion/include/svn_client.h
+++ b/subversion/include/svn_client.h
@@ -3139,6 +3139,29 @@ svn_client_diff6(const apr_array_header_t *diff_options,
                  svn_client_ctx_t *ctx,
                  apr_pool_t *pool);
 
+svn_error_t *
+svn_client_diff6_diffstat(const apr_array_header_t *diff_options,
+                 const char *path_or_url1,
+                 const svn_opt_revision_t *revision1,
+                 const char *path_or_url2,
+                 const svn_opt_revision_t *revision2,
+                 const char *relative_to_dir,
+                 svn_depth_t depth,
+                 svn_boolean_t ignore_ancestry,
+                 svn_boolean_t no_diff_added,
+                 svn_boolean_t no_diff_deleted,
+                 svn_boolean_t show_copies_as_adds,
+                 svn_boolean_t ignore_content_type,
+                 svn_boolean_t ignore_properties,
+                 svn_boolean_t properties_only,
+                 svn_boolean_t use_git_diff_format,
+                 const char *header_encoding,
+                 svn_stream_t *outstream,
+                 svn_stream_t *errstream,
+                 const apr_array_header_t *changelists,
+                 svn_client_ctx_t *ctx,
+                 apr_pool_t *pool);
+
 /** Similar to svn_client_diff6(), but with @a outfile and @a errfile,
  * instead of @a outstream and @a errstream, and with @a
  * no_diff_added, @a ignore_properties, and @a properties_only always
diff --git a/subversion/libsvn_client/diff.c b/subversion/libsvn_client/diff.c
index 8c7701a..46eb3c3 100644
--- a/subversion/libsvn_client/diff.c
+++ b/subversion/libsvn_client/diff.c
@@ -2669,6 +2669,98 @@ svn_client_diff6(const apr_array_header_t *options,
 }
 
 svn_error_t *
+svn_client_diff6_diffstat(const apr_array_header_t *options,
+                 const char *path_or_url1,
+                 const svn_opt_revision_t *revision1,
+                 const char *path_or_url2,
+                 const svn_opt_revision_t *revision2,
+                 const char *relative_to_dir,
+                 svn_depth_t depth,
+                 svn_boolean_t ignore_ancestry,
+                 svn_boolean_t no_diff_added,
+                 svn_boolean_t no_diff_deleted,
+                 svn_boolean_t show_copies_as_adds,
+                 svn_boolean_t ignore_content_type,
+                 svn_boolean_t ignore_properties,
+                 svn_boolean_t properties_only,
+                 svn_boolean_t use_git_diff_format,
+                 const char *header_encoding,
+                 svn_stream_t *outstream,
+                 svn_stream_t *errstream,
+                 const apr_array_header_t *changelists,
+                 svn_client_ctx_t *ctx,
+                 apr_pool_t *pool)
+{
+  diff_writer_info_t dwi = { 0 };
+  svn_opt_revision_t peg_revision;
+  const svn_diff_tree_processor_t *diff_processor;
+  svn_diff_tree_processor_t *processor;
+
+  if (ignore_properties && properties_only)
+    return svn_error_create(SVN_ERR_INCORRECT_PARAMS, NULL,
+                            _("Cannot ignore properties and show only "
+                              "properties at the same time"));
+
+  /* We will never do a pegged diff from here. */
+  peg_revision.kind = svn_opt_revision_unspecified;
+
+  /* setup callback and baton */
+  dwi.ddi.orig_path_1 = path_or_url1;
+  dwi.ddi.orig_path_2 = path_or_url2;
+
+  SVN_ERR(create_diff_writer_info(&dwi, options,
+                                  ctx->config, pool));
+  dwi.pool = pool;
+  dwi.outstream = outstream;
+  dwi.errstream = errstream;
+  dwi.header_encoding = header_encoding;
+
+  dwi.force_binary = ignore_content_type;
+  dwi.ignore_properties = ignore_properties;
+  dwi.properties_only = properties_only;
+  dwi.relative_to_dir = relative_to_dir;
+  dwi.use_git_diff_format = use_git_diff_format;
+  dwi.no_diff_added = no_diff_added;
+  dwi.no_diff_deleted = no_diff_deleted;
+  dwi.show_copies_as_adds = show_copies_as_adds;
+  dwi.diffstat = TRUE;
+  SVN_ERR(svn_diff_create_dfctx(&dwi.dfstat_ctx));
+
+  dwi.cancel_func = ctx->cancel_func;
+  dwi.cancel_baton = ctx->cancel_baton;
+
+  dwi.wc_ctx = ctx->wc_ctx;
+  dwi.ddi.session_relpath = NULL;
+  dwi.ddi.anchor = NULL;
+
+  processor = svn_diff__tree_processor_create(&dwi, pool);
+
+  processor->dir_added = diff_dir_added;
+  processor->dir_changed = diff_dir_changed;
+  processor->dir_deleted = diff_dir_deleted;
+
+  processor->file_added = diff_file_added;
+  processor->file_changed = diff_file_changed;
+  processor->file_deleted = diff_file_deleted;
+
+  diff_processor = processor;
+
+  /* --show-copies-as-adds and --git imply --notice-ancestry */
+  if (show_copies_as_adds || use_git_diff_format)
+    ignore_ancestry = FALSE;
+
+  SVN_ERR(do_diff(NULL, NULL, &dwi.ddi,
+                                 path_or_url1, path_or_url2,
+                                 revision1, revision2, &peg_revision,
+                                 depth, ignore_ancestry, changelists,
+                                 TRUE /* text_deltas */,
+                                 diff_processor, ctx, pool, pool));
+  SVN_ERR(svn_diff_output_dfstat(outstream, dwi.dfstat_ctx));
+  svn_diff_destroy_dfctx(dwi.dfstat_ctx);
+  return SVN_NO_ERROR;
+}
+
+svn_error_t *
 svn_client_diff_peg6(const apr_array_header_t *options,
                      const char *path_or_url,
                      const svn_opt_revision_t *peg_revision,
diff --git a/subversion/svn/diff-cmd.c b/subversion/svn/diff-cmd.c
index b40810f..6cafc42 100644
--- a/subversion/svn/diff-cmd.c
+++ b/subversion/svn/diff-cmd.c
@@ -41,7 +41,6 @@
 #include "cl.h"
 
 #include "svn_private_config.h"
-#include "private/svn_color.h"
 
 
 /*** Code. ***/
@@ -207,8 +206,6 @@ svn_cl__diff(apr_getopt_t *os,
   struct summarize_baton_t summarize_baton;
   const svn_client_diff_summarize_func_t summarize_func =
     (opt_state->xml ? summarize_xml : summarize_regular);
-  svn_stream_t *diffstatin;
-  apr_proc_t diffstatproc;
 
   if (opt_state->extensions)
     options = svn_cstring_split(opt_state->extensions, " \t\n\r", TRUE, pool);
@@ -419,35 +416,6 @@ svn_cl__diff(apr_getopt_t *os,
 
   iterpool = svn_pool_create(pool);
 
-  if (opt_state->diff.diffstat)
-    {
-      apr_procattr_t *attr;
-      apr_status_t apr_err;
-      const char *progname = "diffstat";
-      const char *args1[] = { progname, "-E", "-C", "-p0", NULL, };
-      const char *args2[] = { progname, NULL, };
-
-      apr_err = apr_procattr_create(&attr, pool);
-      if (apr_err)
-        return svn_error_wrap_apr(apr_err,
-            _("Can't create process '%s' attributes"), progname);
-      apr_err = apr_procattr_cmdtype_set(attr, APR_PROGRAM_PATH);
-      if (apr_err)
-        return svn_error_wrap_apr(apr_err,
-            _("Can't set process '%s' cmdtype"), progname);
-      apr_err = apr_procattr_io_set(attr, APR_FULL_BLOCK, APR_NO_PIPE,
-          APR_NO_PIPE);
-      if (apr_err)
-        return svn_error_wrap_apr(apr_err,
-            _("Can't set process '%s' io"), progname);
-      apr_err = apr_proc_create(&diffstatproc, progname,
-          (dont_use_color ? args2 : args1), NULL, attr, pool);
-      if (apr_err)
-        return svn_error_wrap_apr(apr_err,
-            _("Can't start process '%s'"), progname);
-      diffstatin = svn_stream_from_aprfile2(diffstatproc.in, FALSE, pool);
-    }
-
   for (i = 0; i < targets->nelts; ++i)
     {
       const char *path = APR_ARRAY_IDX(targets, i, const char *);
@@ -495,7 +463,7 @@ svn_cl__diff(apr_getopt_t *os,
                                 ctx, iterpool));
             }
           else if (opt_state->diff.diffstat)
-            SVN_ERR(svn_client_diff6(
+            SVN_ERR(svn_client_diff6_diffstat(
                      options,
                      target1,
                      &(opt_state->start_revision),
@@ -512,7 +480,7 @@ svn_cl__diff(apr_getopt_t *os,
                      opt_state->diff.properties_only,
                      opt_state->diff.use_git_diff_format,
                      svn_cmdline_output_encoding(pool),
-                     diffstatin,
+                     outstream,
                      errstream,
                      opt_state->changelists,
                      ctx, iterpool));
@@ -602,13 +570,6 @@ svn_cl__diff(apr_getopt_t *os,
     }
 
   svn_pool_destroy(iterpool);
-  if (opt_state->diff.diffstat)
-    {
-      int c;
-      apr_exit_why_e e;
-      svn_stream_close(diffstatin);
-      apr_proc_wait(&diffstatproc, &c, &e, APR_WAIT);
-    }
 
   return SVN_NO_ERROR;
 }
diff --git a/subversion/svn/svn.c b/subversion/svn/svn.c
index 2f416c3..152d708 100644
--- a/subversion/svn/svn.c
+++ b/subversion/svn/svn.c
@@ -760,7 +760,7 @@ const svn_opt_subcommand_desc2_t svn_cl__cmd_table[] =
      opt_ignore_properties, opt_properties_only,
      opt_show_copies_as_adds, opt_notice_ancestry, opt_summarize, opt_changelist,
      opt_force, opt_xml, opt_use_git_diff_format, opt_patch_compatible,
-     opt_no_color, opt_diffstat,} },
+     opt_no_color, opt_diffstat, } },
   { "export", svn_cl__export, {0}, N_
     ("Create an unversioned copy of a tree.\n"
      "usage: 1. export [-r REV] URL[@PEGREV] [PATH]\n"
-- 
1.8.3.1

