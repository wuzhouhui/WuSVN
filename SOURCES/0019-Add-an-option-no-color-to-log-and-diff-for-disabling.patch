From 55c2bfa5542bdd7330bb2219ffc18ddb16019519 Mon Sep 17 00:00:00 2001
From: Serious Man <wuzhouhui250@gmail.com>
Date: Sat, 31 Dec 2016 09:59:57 +0800
Subject: [PATCH 19/95] Add an option '--no-color' to log and diff, for
 disabling syntax highlight

---
 subversion/include/private/svn_color.h |  2 ++
 subversion/libsvn_client/diff.c        | 12 +++++-------
 subversion/libsvn_diff/diff_file.c     |  4 +---
 subversion/libsvn_diff/diff_memory.c   |  4 +---
 subversion/libsvn_diff/util.c          |  6 +++---
 subversion/svn/cl.h                    |  1 +
 subversion/svn/log-cmd.c               |  4 +---
 subversion/svn/svn.c                   | 21 +++++++++++++++------
 8 files changed, 29 insertions(+), 25 deletions(-)

diff --git a/subversion/include/private/svn_color.h b/subversion/include/private/svn_color.h
index b6949c9..d896106 100644
--- a/subversion/include/private/svn_color.h
+++ b/subversion/include/private/svn_color.h
@@ -9,4 +9,6 @@
 #define SVN_COLOR_MAGENTA      "\033[35m"
 #define SVN_COLOR_CYAN         "\033[36m"
 
+extern svn_boolean_t dont_use_color;
+
 #endif /* SVN_COLOR_H */
diff --git a/subversion/libsvn_client/diff.c b/subversion/libsvn_client/diff.c
index caeb65e..c4f6b0d 100644
--- a/subversion/libsvn_client/diff.c
+++ b/subversion/libsvn_client/diff.c
@@ -57,8 +57,6 @@
 
 #include "svn_private_config.h"
 
-extern int stdout_is_tty;
-
 
 /* Utilities */
 
@@ -556,7 +554,7 @@ display_prop_diffs(const apr_array_header_t *propchanges,
       /* ### Should we show the paths in platform specific format,
        * ### diff_content_changed() does not! */
 
-      if (stdout_is_tty)
+      if (!dont_use_color)
         SVN_ERR(svn_stream_printf_from_utf8(outstream, encoding, scratch_pool,
 			      SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
 			      SVN_DIFF__EQUAL_STRING APR_EOL_STR,
@@ -878,7 +876,7 @@ diff_content_changed(svn_boolean_t *wrote_header,
   if (! dwi->force_binary && (mt1_binary || mt2_binary))
     {
       /* Print out the diff header. */
-      if (stdout_is_tty)
+      if (!dont_use_color)
         SVN_ERR(svn_stream_printf_from_utf8(outstream,
 		 dwi->header_encoding, scratch_pool,
 		 SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
@@ -1063,7 +1061,7 @@ diff_content_changed(svn_boolean_t *wrote_header,
           || svn_diff_contains_diffs(diff))
         {
           /* Print out the diff header. */
-	  if (stdout_is_tty)
+	  if (!dont_use_color)
             SVN_ERR(svn_stream_printf_from_utf8(outstream,
 		     dwi->header_encoding, scratch_pool,
 		     SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
@@ -1242,7 +1240,7 @@ diff_file_added(const char *relpath,
         index_path = svn_dirent_join(dwi->ddi.anchor, relpath,
                                      scratch_pool);
 
-      if (stdout_is_tty)
+      if (!dont_use_color)
         SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
                   dwi->header_encoding, scratch_pool,
                   SVN_COLOR_BLUE "Index: %s%s (added)" APR_EOL_STR
@@ -1314,7 +1312,7 @@ diff_file_deleted(const char *relpath,
         index_path = svn_dirent_join(dwi->ddi.anchor, relpath,
                                      scratch_pool);
 
-      if (stdout_is_tty)
+      if (!dont_use_color)
         SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
                   dwi->header_encoding, scratch_pool,
                   SVN_COLOR_BLUE "Index: %s%s (deleted)" APR_EOL_STR
diff --git a/subversion/libsvn_diff/diff_file.c b/subversion/libsvn_diff/diff_file.c
index 703ba9b..976eb7e 100644
--- a/subversion/libsvn_diff/diff_file.c
+++ b/subversion/libsvn_diff/diff_file.c
@@ -53,8 +53,6 @@
 #include "private/svn_diff_private.h"
 #include "private/svn_color.h"
 
-extern int stdout_is_tty;
-
 /* A token, i.e. a line read from a file. */
 typedef struct svn_diff__file_token_t
 {
@@ -1893,7 +1891,7 @@ svn_diff_file_output_unified4(svn_stream_t *output_stream,
 
       SVN_ERR(svn_utf_cstring_from_utf8_ex2(&baton.context_str, " ",
                                             header_encoding, pool));
-      if (stdout_is_tty) {
+      if (!dont_use_color) {
         SVN_ERR(svn_utf_cstring_from_utf8_ex2(&baton.delete_str,
                           SVN_COLOR_RED "-", header_encoding, pool));
         SVN_ERR(svn_utf_cstring_from_utf8_ex2(&baton.insert_str,
diff --git a/subversion/libsvn_diff/diff_memory.c b/subversion/libsvn_diff/diff_memory.c
index 8fedf61..206cd37 100644
--- a/subversion/libsvn_diff/diff_memory.c
+++ b/subversion/libsvn_diff/diff_memory.c
@@ -40,8 +40,6 @@
 #include "private/svn_diff_private.h"
 #include "private/svn_color.h"
 
-extern int stdout_is_tty;
-
 typedef struct source_tokens_t
 {
   /* A token simply is an svn_string_t pointing to
@@ -648,7 +646,7 @@ svn_diff_mem_string_output_unified3(svn_stream_t *output_stream,
       SVN_ERR(svn_utf_cstring_from_utf8_ex2
               (&(baton.prefix_str[unified_output_context]), " ",
                header_encoding, scratch_pool));
-      if (stdout_is_tty) {
+      if (!dont_use_color) {
         SVN_ERR(svn_utf_cstring_from_utf8_ex2
               (&(baton.prefix_str[unified_output_delete]), SVN_COLOR_RED "-",
                header_encoding, scratch_pool));
diff --git a/subversion/libsvn_diff/util.c b/subversion/libsvn_diff/util.c
index da6565a..e592bb2 100644
--- a/subversion/libsvn_diff/util.c
+++ b/subversion/libsvn_diff/util.c
@@ -44,7 +44,7 @@
 
 #include "svn_private_config.h"
 
-int stdout_is_tty;
+svn_boolean_t dont_use_color = TRUE;
 
 svn_boolean_t
 svn_diff_contains_conflicts(svn_diff_t *diff)
@@ -377,7 +377,7 @@ svn_diff__unified_write_hunk_header(svn_stream_t *output_stream,
                                     const char *hunk_extra_context,
                                     apr_pool_t *scratch_pool)
 {
-  if (stdout_is_tty)
+  if (!dont_use_color)
     SVN_ERR(svn_stream_printf_from_utf8(output_stream, header_encoding,
 					scratch_pool,
 					SVN_COLOR_YELLOW "%s -%" APR_OFF_T_FMT,
@@ -424,7 +424,7 @@ svn_diff__unidiff_write_header(svn_stream_t *output_stream,
                                const char *new_header,
                                apr_pool_t *scratch_pool)
 {
-  if (stdout_is_tty)
+  if (!dont_use_color)
     SVN_ERR(svn_stream_printf_from_utf8(output_stream, header_encoding,
                                         scratch_pool,
                                         SVN_COLOR_BLUE "--- %s" APR_EOL_STR
diff --git a/subversion/svn/cl.h b/subversion/svn/cl.h
index a5b1d9b..f68e5c1 100644
--- a/subversion/svn/cl.h
+++ b/subversion/svn/cl.h
@@ -198,6 +198,7 @@ typedef struct svn_cl__opt_state_t
   svn_boolean_t ignore_properties;   /* ignore properties */
   svn_boolean_t properties_only;     /* Show properties only */
   svn_boolean_t patch_compatible;    /* Output compatible with GNU patch */
+  svn_boolean_t no_color;            /* Disable syntax highlight */
     } diff;
   svn_boolean_t ignore_ancestry; /* ignore ancestry for merge-y operations */
   svn_boolean_t ignore_externals;/* ignore externals definitions */
diff --git a/subversion/svn/log-cmd.c b/subversion/svn/log-cmd.c
index 9108681..dce1465 100644
--- a/subversion/svn/log-cmd.c
+++ b/subversion/svn/log-cmd.c
@@ -41,8 +41,6 @@
 #include "private/svn_utf_private.h"
 #include "private/svn_color.h"
 
-extern int stdout_is_tty;
-
 #include "cl.h"
 #include "cl-log.h"
 
@@ -366,7 +364,7 @@ svn_cl__log_entry_receiver(void *baton,
       return SVN_NO_ERROR;
     }
 
-  if (stdout_is_tty)
+  if (!dont_use_color)
     SVN_ERR(svn_cmdline_printf(pool,
                                SVN_COLOR_MAGENTA SVN_CL__LOG_SEP_STRING
                                SVN_COLOR_MAGENTA "r%ld | %s | %s",
diff --git a/subversion/svn/svn.c b/subversion/svn/svn.c
index ea0ea6d..ac1f027 100644
--- a/subversion/svn/svn.c
+++ b/subversion/svn/svn.c
@@ -58,11 +58,10 @@
 #include "private/svn_cmdline_private.h"
 #include "private/svn_subr_private.h"
 #include "private/svn_utf_private.h"
+#include "private/svn_color.h"
 
 #include "svn_private_config.h"
 
-extern int stdout_is_tty;
-
 
 /*** Option Processing ***/
 
@@ -89,6 +88,7 @@ typedef enum svn_cl__longopt_t {
   opt_ignore_properties,
   opt_properties_only,
   opt_patch_compatible,
+  opt_no_color,
   /* end of diff options */
   opt_dry_run,
   opt_editor_cmd,
@@ -398,6 +398,7 @@ const apr_getopt_option_t svn_cl__options[] =
                        "                             "
                        "--show-copies-as-adds --ignore-properties"
                        )},
+  {"no-color", opt_no_color, 0, N_("disable syntax highlight")},
   /* end of diff options */
   {"allow-mixed-revisions", opt_allow_mixed_revisions, 0,
                        N_("Allow operation on mixed-revision working copy.\n"
@@ -751,7 +752,8 @@ const svn_opt_subcommand_desc2_t svn_cl__cmd_table[] =
      opt_internal_diff, 'x', opt_no_diff_added, opt_no_diff_deleted,
      opt_ignore_properties, opt_properties_only,
      opt_show_copies_as_adds, opt_notice_ancestry, opt_summarize, opt_changelist,
-     opt_force, opt_xml, opt_use_git_diff_format, opt_patch_compatible} },
+     opt_force, opt_xml, opt_use_git_diff_format, opt_patch_compatible,
+     opt_no_color,} },
   { "export", svn_cl__export, {0}, N_
     ("Create an unversioned copy of a tree.\n"
      "usage: 1. export [-r REV] URL[@PEGREV] [PATH]\n"
@@ -969,7 +971,7 @@ const svn_opt_subcommand_desc2_t svn_cl__cmd_table[] =
     {'r', 'c', 'q', 'v', 'g', opt_targets, opt_stop_on_copy, opt_incremental,
      opt_xml, 'l', opt_with_all_revprops, opt_with_no_revprops,
      opt_with_revprop, opt_depth, opt_diff, opt_diff_cmd,
-     opt_internal_diff, 'x', opt_search, opt_search_and },
+     opt_internal_diff, 'x', opt_search, opt_search_and, opt_no_color },
     {{opt_with_revprop, N_("retrieve revision property ARG")},
      {'c', N_("the change made in revision ARG")},
      {'v', N_("also print all affected paths")},
@@ -2592,6 +2594,9 @@ sub_main(int *exit_code, int argc, const char *argv[], apr_pool_t *pool,
       case opt_patch_compatible:
         opt_state.diff.patch_compatible = TRUE;
         break;
+      case opt_no_color:
+	opt_state.diff.no_color = TRUE;
+	break;
       case opt_use_git_diff_format:
         opt_state.diff.use_git_diff_format = TRUE;
         break;
@@ -3247,8 +3252,12 @@ sub_main(int *exit_code, int argc, const char *argv[], apr_pool_t *pool,
     ctx->conflict_baton2 = NULL;
   }
 
-  stdout_is_tty = isatty(STDOUT_FILENO);
-  if (stdout_is_tty && (subcommand->cmd_func == svn_cl__blame ||
+  if (isatty(STDOUT_FILENO)) {
+    if ((subcommand->cmd_func == svn_cl__diff || subcommand->cmd_func ==
+          svn_cl__log) && opt_state.diff.no_color == FALSE)
+			dont_use_color = FALSE;
+  }
+  if (isatty(STDOUT_FILENO) && (subcommand->cmd_func == svn_cl__blame ||
 		  subcommand->cmd_func == svn_cl__cat ||
 		  subcommand->cmd_func == svn_cl__diff ||
 		  subcommand->cmd_func == svn_cl__log ||
-- 
1.8.3.1

