From e741246346448a2a065a9c5f63cc62a72f5a4386 Mon Sep 17 00:00:00 2001
From: wuzhouhui <wuzhouhui250@gmail.com>
Date: Tue, 17 Oct 2017 12:49:12 +0800
Subject: [PATCH 60/95] Patching subversion-1.9.4-diffstat-binary.patch

---
 subversion/include/svn_diff.h   | 8 +++++++-
 subversion/libsvn_client/diff.c | 4 ++--
 subversion/libsvn_diff/diff.c   | 9 +++++++--
 subversion/libsvn_diff/diff.h   | 1 +
 4 files changed, 17 insertions(+), 5 deletions(-)

diff --git a/subversion/include/svn_diff.h b/subversion/include/svn_diff.h
index 690c576..15875a6 100644
--- a/subversion/include/svn_diff.h
+++ b/subversion/include/svn_diff.h
@@ -1379,10 +1379,16 @@ svn_diff_create_dfctx(svn_dfstat_ctx_t **ctx);
 void
 svn_diff_destroy_dfctx(svn_dfstat_ctx_t *ctx);
 
+enum svn_dfstat_cmt {
+	svn_dfstat_normal = 0,
+	svn_dfstat_bin,
+};
+
 svn_error_t *
 svn_diff_stat(svn_dfstat_ctx_t *ctx,
     const svn_diff_t *diff,
-    const char *file_path);
+    const char *file_path,
+    enum svn_dfstat_cmt cmt);
 
 svn_error_t *
 svn_diff_output_dfstat(svn_stream_t *out,
diff --git a/subversion/libsvn_client/diff.c b/subversion/libsvn_client/diff.c
index a7964b7..1b3a2a1 100644
--- a/subversion/libsvn_client/diff.c
+++ b/subversion/libsvn_client/diff.c
@@ -980,7 +980,7 @@ diff_content_changed(svn_boolean_t *wrote_header,
   else if (! dwi->force_binary && (mt1_binary || mt2_binary) && dwi->diffstat)
     {
       /* Suppress binary files' warning */
-      SVN_ERR(svn_diff_stat(dwi->dfstat_ctx, NULL, diff_relpath));
+      SVN_ERR(svn_diff_stat(dwi->dfstat_ctx, NULL, diff_relpath, svn_dfstat_bin));
       return SVN_NO_ERROR;
     }
 
@@ -1066,7 +1066,7 @@ diff_content_changed(svn_boolean_t *wrote_header,
             dwi->options.for_internal,
             scratch_pool));
       if (svn_diff_contains_diffs(diff))
-        SVN_ERR(svn_diff_stat(dwi->dfstat_ctx, diff, diff_relpath));
+        SVN_ERR(svn_diff_stat(dwi->dfstat_ctx, diff, diff_relpath, 0));
     }
   else   /* use libsvn_diff to generate the diff  */
     {
diff --git a/subversion/libsvn_diff/diff.c b/subversion/libsvn_diff/diff.c
index cea1376..a555d3d 100644
--- a/subversion/libsvn_diff/diff.c
+++ b/subversion/libsvn_diff/diff.c
@@ -772,7 +772,10 @@ show_data(DATA * p)
 	    printf("%*ld ", number_len, DelOf(p));
 	}
 	putchar('|');
-        plot_numbers(p);
+	if (p->cmt == svn_dfstat_bin)
+		printf("binary");
+	else
+		plot_numbers(p);
 	printf("\n");
     }
 }
@@ -996,10 +999,12 @@ svn_diff_destroy_dfctx(svn_dfstat_ctx_t *ctx)
 svn_error_t *
 svn_diff_stat(svn_dfstat_ctx_t *head,
     const svn_diff_t *diff,
-    const char *file_path)
+    const char *file_path,
+    enum svn_dfstat_cmt cmt)
 {
   svn_dfstat_ctx_t *t = apr_pcalloc(dfctx_pool, sizeof(*t));
   t->file_path = apr_pstrdup(dfctx_pool, file_path);
+  t->cmt = cmt;
   t->next = head->next;
   head->next = (void *)t;
   while (diff)
diff --git a/subversion/libsvn_diff/diff.h b/subversion/libsvn_diff/diff.h
index d149b3b..c5baad6 100644
--- a/subversion/libsvn_diff/diff.h
+++ b/subversion/libsvn_diff/diff.h
@@ -63,6 +63,7 @@ struct svn_dfstat_ctx_s {
   void *next;
   char *file_path;
   int base;
+  enum svn_dfstat_cmt cmt;
   svn_linenum_t inserted_num;
   svn_linenum_t deleted_num;
 };
-- 
1.8.3.1

