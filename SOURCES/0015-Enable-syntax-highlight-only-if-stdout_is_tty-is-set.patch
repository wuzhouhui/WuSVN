From eed6246e1a4ba24da257274cb62b41baf5f7e9e2 Mon Sep 17 00:00:00 2001
From: wuzhouhui <wuzhouhui250@gmail.com>
Date: Wed, 28 Dec 2016 20:15:28 +0800
Subject: [PATCH 15/95] Enable syntax highlight only if stdout_is_tty is set

---
 subversion/libsvn_client/diff.c      |  4 ----
 subversion/libsvn_diff/diff.h        |  1 -
 subversion/libsvn_diff/diff_file.c   | 10 +++-------
 subversion/libsvn_diff/diff_memory.c |  4 +++-
 subversion/libsvn_diff/util.c        |  3 ---
 5 files changed, 6 insertions(+), 16 deletions(-)

diff --git a/subversion/libsvn_client/diff.c b/subversion/libsvn_client/diff.c
index ca585e3..e96ae94 100644
--- a/subversion/libsvn_client/diff.c
+++ b/subversion/libsvn_client/diff.c
@@ -56,7 +56,6 @@
 
 #include "svn_private_config.h"
 
-void svn_diff_use_color(svn_diff_t *);
 extern int stdout_is_tty;
 
 
@@ -1045,9 +1044,6 @@ diff_content_changed(svn_boolean_t *wrote_header,
       SVN_ERR(svn_diff_file_diff_2(&diff, tmpfile1, tmpfile2,
                                    dwi->options.for_internal,
                                    scratch_pool));
-      if (diff && stdout_is_tty)
-        svn_diff_use_color(diff);
-
       if (force_diff
           || dwi->use_git_diff_format
           || svn_diff_contains_diffs(diff))
diff --git a/subversion/libsvn_diff/diff.h b/subversion/libsvn_diff/diff.h
index 2a0fa48..7628e65 100644
--- a/subversion/libsvn_diff/diff.h
+++ b/subversion/libsvn_diff/diff.h
@@ -57,7 +57,6 @@ struct svn_diff_t {
   apr_off_t latest_start;
   apr_off_t latest_length;
   svn_diff_t *resolved_diff;
-  int wzh_used; /* used by wzh, don't touch it */
 };
 
 /* Type used for token indices and counts of tokens. Must be signed. */
diff --git a/subversion/libsvn_diff/diff_file.c b/subversion/libsvn_diff/diff_file.c
index 0e0a67f..703ba9b 100644
--- a/subversion/libsvn_diff/diff_file.c
+++ b/subversion/libsvn_diff/diff_file.c
@@ -53,6 +53,8 @@
 #include "private/svn_diff_private.h"
 #include "private/svn_color.h"
 
+extern int stdout_is_tty;
+
 /* A token, i.e. a line read from a file. */
 typedef struct svn_diff__file_token_t
 {
@@ -1313,12 +1315,6 @@ svn_diff_file_options_parse(svn_diff_file_options_t *options,
   return SVN_NO_ERROR;
 }
 
-void
-svn_diff_use_color(svn_diff_t *diff)
-{
-  diff->wzh_used = SVN_USE_COLOR_MAGIC;
-}
-
 svn_error_t *
 svn_diff_file_diff_2(svn_diff_t **diff,
                      const char *original,
@@ -1897,7 +1893,7 @@ svn_diff_file_output_unified4(svn_stream_t *output_stream,
 
       SVN_ERR(svn_utf_cstring_from_utf8_ex2(&baton.context_str, " ",
                                             header_encoding, pool));
-      if (diff->wzh_used == SVN_USE_COLOR_MAGIC) {
+      if (stdout_is_tty) {
         SVN_ERR(svn_utf_cstring_from_utf8_ex2(&baton.delete_str,
                           SVN_COLOR_RED "-", header_encoding, pool));
         SVN_ERR(svn_utf_cstring_from_utf8_ex2(&baton.insert_str,
diff --git a/subversion/libsvn_diff/diff_memory.c b/subversion/libsvn_diff/diff_memory.c
index 518c1bb..8fedf61 100644
--- a/subversion/libsvn_diff/diff_memory.c
+++ b/subversion/libsvn_diff/diff_memory.c
@@ -40,6 +40,8 @@
 #include "private/svn_diff_private.h"
 #include "private/svn_color.h"
 
+extern int stdout_is_tty;
+
 typedef struct source_tokens_t
 {
   /* A token simply is an svn_string_t pointing to
@@ -646,7 +648,7 @@ svn_diff_mem_string_output_unified3(svn_stream_t *output_stream,
       SVN_ERR(svn_utf_cstring_from_utf8_ex2
               (&(baton.prefix_str[unified_output_context]), " ",
                header_encoding, scratch_pool));
-      if (diff->wzh_used == SVN_USE_COLOR_MAGIC) {
+      if (stdout_is_tty) {
         SVN_ERR(svn_utf_cstring_from_utf8_ex2
               (&(baton.prefix_str[unified_output_delete]), SVN_COLOR_RED "-",
                header_encoding, scratch_pool));
diff --git a/subversion/libsvn_diff/util.c b/subversion/libsvn_diff/util.c
index 9dfbb5c..2ac3695 100644
--- a/subversion/libsvn_diff/util.c
+++ b/subversion/libsvn_diff/util.c
@@ -43,7 +43,6 @@
 
 #include "svn_private_config.h"
 
-void svn_diff_use_color(svn_diff_t *);
 int stdout_is_tty;
 
 svn_boolean_t
@@ -597,8 +596,6 @@ svn_diff__display_prop_diffs(svn_stream_t *outstream,
 
         SVN_ERR(svn_diff_mem_string_diff(&diff, orig, val, &options,
                                          iterpool));
-	if (diff && stdout_is_tty)
-          svn_diff_use_color(diff);
 
         /* UNIX patch will try to apply a diff even if the diff header
          * is missing. It tries to be helpful by asking the user for a
-- 
1.8.3.1

