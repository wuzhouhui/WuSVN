From 5055f2966f61c722b132635c7239cabf83b3b83b Mon Sep 17 00:00:00 2001
From: wuzhouhui <wuzhouhui250@gmail.com>
Date: Wed, 28 Dec 2016 20:33:28 +0800
Subject: [PATCH] Print paths with color in diff mode

---
 subversion/include/private/svn_color.h |  1 +
 subversion/libsvn_client/diff.c        | 83 ++++++++++++++++++++++++----------
 subversion/libsvn_diff/util.c          | 21 ++++++---
 3 files changed, 75 insertions(+), 30 deletions(-)

Index: subversion-1.8.16/subversion/include/private/svn_color.h
===================================================================
--- subversion-1.8.16.orig/subversion/include/private/svn_color.h
+++ subversion-1.8.16/subversion/include/private/svn_color.h
@@ -4,5 +4,6 @@
 #define SVN_USE_COLOR_MAGIC   0x8a3f
 #define SVN_COLOR_RED          "\033[31m"
 #define SVN_COLOR_GREEN        "\033[32m"
+#define SVN_COLOR_BLUE         "\033[34m"
 
 #endif /* SVN_COLOR_H */
Index: subversion-1.8.16/subversion/libsvn_client/diff.c
===================================================================
--- subversion-1.8.16.orig/subversion/libsvn_client/diff.c
+++ subversion-1.8.16/subversion/libsvn_client/diff.c
@@ -52,6 +52,7 @@
 #include "private/svn_diff_private.h"
 #include "private/svn_subr_private.h"
 #include "private/svn_io_private.h"
+#include "private/svn_color.h"
 
 #include "svn_private_config.h"
 
@@ -491,10 +492,16 @@ display_prop_diffs(const apr_array_heade
       /* ### Should we show the paths in platform specific format,
        * ### diff_content_changed() does not! */
 
-      SVN_ERR(svn_stream_printf_from_utf8(outstream, encoding, scratch_pool,
-                                          "Index: %s" APR_EOL_STR
-                                          SVN_DIFF__EQUAL_STRING APR_EOL_STR,
-                                          index_path));
+      if (stdout_is_tty)
+        SVN_ERR(svn_stream_printf_from_utf8(outstream, encoding, scratch_pool,
+			      SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
+			      SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+			      SVN_COLOR_BLUE, index_path));
+      else
+        SVN_ERR(svn_stream_printf_from_utf8(outstream, encoding, scratch_pool,
+			      "Index: %s" APR_EOL_STR
+			      SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+			      index_path));
 
       if (use_git_diff_format)
         SVN_ERR(print_git_diff_header(outstream, &label1, &label2,
@@ -749,11 +756,18 @@ diff_content_changed(svn_boolean_t *wrot
   if (! diff_cmd_baton->force_binary && (mt1_binary || mt2_binary))
     {
       /* Print out the diff header. */
-      SVN_ERR(svn_stream_printf_from_utf8(outstream,
-               diff_cmd_baton->header_encoding, scratch_pool,
-               "Index: %s" APR_EOL_STR
-               SVN_DIFF__EQUAL_STRING APR_EOL_STR,
-               index_path));
+      if (stdout_is_tty)
+        SVN_ERR(svn_stream_printf_from_utf8(outstream,
+		 dwi->header_encoding, scratch_pool,
+		 SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
+		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+		 SVN_COLOR_BLUE, index_path));
+      else
+        SVN_ERR(svn_stream_printf_from_utf8(outstream,
+		 dwi->header_encoding, scratch_pool,
+		 "Index: %s" APR_EOL_STR
+		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+		 index_path));
 
       /* ### Print git diff headers. */
 
@@ -798,11 +812,18 @@ diff_content_changed(svn_boolean_t *wrot
       svn_stream_t *stream;
 
       /* Print out the diff header. */
-      SVN_ERR(svn_stream_printf_from_utf8(outstream,
-               diff_cmd_baton->header_encoding, scratch_pool,
-               "Index: %s" APR_EOL_STR
-               SVN_DIFF__EQUAL_STRING APR_EOL_STR,
-               index_path));
+      if (stdout_is_tty)
+	SVN_ERR(svn_stream_printf_from_utf8(outstream,
+		 dwi->header_encoding, scratch_pool,
+		 SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
+		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+		 SVN_COLOR_BLUE, index_path));
+      else
+	SVN_ERR(svn_stream_printf_from_utf8(outstream,
+		 dwi->header_encoding, scratch_pool,
+		 "Index: %s" APR_EOL_STR
+		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+		 index_path));
 
       /* ### Do we want to add git diff headers here too? I'd say no. The
        * ### 'Index' and '===' line is something subversion has added. The rest
@@ -1053,11 +1074,18 @@ diff_file_added(svn_wc_notify_state_t *c
         index_path = svn_dirent_join(diff_cmd_baton->anchor, diff_relpath,
                                      scratch_pool);
 
-      SVN_ERR(svn_stream_printf_from_utf8(diff_cmd_baton->outstream,
-                diff_cmd_baton->header_encoding, scratch_pool,
-                "Index: %s (added)" APR_EOL_STR
-                SVN_DIFF__EQUAL_STRING APR_EOL_STR,
-                index_path));
+      if (stdout_is_tty)
+        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
+                  dwi->header_encoding, scratch_pool,
+                  SVN_COLOR_BLUE "Index: %s%s (added)" APR_EOL_STR
+                  SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+                  SVN_COLOR_BLUE, index_path));
+      else
+        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
+                  dwi->header_encoding, scratch_pool,
+                  "Index: %s (added)" APR_EOL_STR
+                  SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+                  index_path));
       wrote_header = TRUE;
     }
   else if (tmpfile1 && copyfrom_path)
@@ -1110,11 +1138,18 @@ diff_file_deleted(svn_wc_notify_state_t 
         index_path = svn_dirent_join(diff_cmd_baton->anchor, diff_relpath,
                                      scratch_pool);
 
-      SVN_ERR(svn_stream_printf_from_utf8(diff_cmd_baton->outstream,
-                diff_cmd_baton->header_encoding, scratch_pool,
-                "Index: %s (deleted)" APR_EOL_STR
-                SVN_DIFF__EQUAL_STRING APR_EOL_STR,
-                index_path));
+      if (stdout_is_tty)
+        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
+                  dwi->header_encoding, scratch_pool,
+                  SVN_COLOR_BLUE "Index: %s%s (deleted)" APR_EOL_STR
+                  SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+                  SVN_COLOR_BLUE, index_path));
+      else
+        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
+                  dwi->header_encoding, scratch_pool,
+                  "Index: %s (deleted)" APR_EOL_STR
+                  SVN_DIFF__EQUAL_STRING APR_EOL_STR,
+                  index_path));
     }
   else
     {
Index: subversion-1.8.16/subversion/libsvn_diff/util.c
===================================================================
--- subversion-1.8.16.orig/subversion/libsvn_diff/util.c
+++ subversion-1.8.16/subversion/libsvn_diff/util.c
@@ -39,6 +39,7 @@
 #include "svn_version.h"
 
 #include "private/svn_diff_private.h"
+#include "private/svn_color.h"
 #include "diff.h"
 
 #include "svn_private_config.h"
@@ -412,12 +413,20 @@ svn_diff__unidiff_write_header(svn_strea
                                const char *new_header,
                                apr_pool_t *scratch_pool)
 {
-  SVN_ERR(svn_stream_printf_from_utf8(output_stream, header_encoding,
-                                      scratch_pool,
-                                      "--- %s" APR_EOL_STR
-                                      "+++ %s" APR_EOL_STR,
-                                      old_header,
-                                      new_header));
+  if (stdout_is_tty)
+    SVN_ERR(svn_stream_printf_from_utf8(output_stream, header_encoding,
+                                        scratch_pool,
+                                        SVN_COLOR_BLUE "--- %s" APR_EOL_STR
+                                        SVN_COLOR_BLUE "+++ %s" APR_EOL_STR,
+                                        old_header,
+                                        new_header));
+  else
+    SVN_ERR(svn_stream_printf_from_utf8(output_stream, header_encoding,
+                                        scratch_pool,
+                                        "--- %s" APR_EOL_STR
+                                        "+++ %s" APR_EOL_STR,
+                                        old_header,
+                                        new_header));
   return SVN_NO_ERROR;
 }
 
Index: subversion-1.8.16/subversion/libsvn_client/diff.c
===================================================================
--- subversion-1.8.16.orig/subversion/libsvn_client/diff.c
+++ subversion-1.8.16/subversion/libsvn_client/diff.c
@@ -757,14 +757,14 @@ diff_content_changed(svn_boolean_t *wrot
     {
       /* Print out the diff header. */
       if (stdout_is_tty)
-        SVN_ERR(svn_stream_printf_from_utf8(outstream,
-		 dwi->header_encoding, scratch_pool,
+	SVN_ERR(svn_stream_printf_from_utf8(outstream,
+		 diff_cmd_baton->header_encoding, scratch_pool,
 		 SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
 		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
 		 SVN_COLOR_BLUE, index_path));
       else
-        SVN_ERR(svn_stream_printf_from_utf8(outstream,
-		 dwi->header_encoding, scratch_pool,
+	SVN_ERR(svn_stream_printf_from_utf8(outstream,
+		 diff_cmd_baton->header_encoding, scratch_pool,
 		 "Index: %s" APR_EOL_STR
 		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
 		 index_path));
@@ -814,13 +814,13 @@ diff_content_changed(svn_boolean_t *wrot
       /* Print out the diff header. */
       if (stdout_is_tty)
 	SVN_ERR(svn_stream_printf_from_utf8(outstream,
-		 dwi->header_encoding, scratch_pool,
+                 diff_cmd_baton->header_encoding, scratch_pool,
 		 SVN_COLOR_BLUE "Index: %s%s" APR_EOL_STR
 		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
 		 SVN_COLOR_BLUE, index_path));
       else
 	SVN_ERR(svn_stream_printf_from_utf8(outstream,
-		 dwi->header_encoding, scratch_pool,
+                 diff_cmd_baton->header_encoding, scratch_pool,
 		 "Index: %s" APR_EOL_STR
 		 SVN_DIFF__EQUAL_STRING APR_EOL_STR,
 		 index_path));
@@ -1075,14 +1075,14 @@ diff_file_added(svn_wc_notify_state_t *c
                                      scratch_pool);
 
       if (stdout_is_tty)
-        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
-                  dwi->header_encoding, scratch_pool,
+        SVN_ERR(svn_stream_printf_from_utf8(diff_cmd_baton->outstream,
+                  diff_cmd_baton->header_encoding, scratch_pool,
                   SVN_COLOR_BLUE "Index: %s%s (added)" APR_EOL_STR
                   SVN_DIFF__EQUAL_STRING APR_EOL_STR,
                   SVN_COLOR_BLUE, index_path));
       else
-        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
-                  dwi->header_encoding, scratch_pool,
+        SVN_ERR(svn_stream_printf_from_utf8(diff_cmd_baton->outstream,
+                  diff_cmd_baton->header_encoding, scratch_pool,
                   "Index: %s (added)" APR_EOL_STR
                   SVN_DIFF__EQUAL_STRING APR_EOL_STR,
                   index_path));
@@ -1139,14 +1139,14 @@ diff_file_deleted(svn_wc_notify_state_t 
                                      scratch_pool);
 
       if (stdout_is_tty)
-        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
-                  dwi->header_encoding, scratch_pool,
+        SVN_ERR(svn_stream_printf_from_utf8(diff_cmd_baton->outstream,
+                  diff_cmd_baton->header_encoding, scratch_pool,
                   SVN_COLOR_BLUE "Index: %s%s (deleted)" APR_EOL_STR
                   SVN_DIFF__EQUAL_STRING APR_EOL_STR,
                   SVN_COLOR_BLUE, index_path));
       else
-        SVN_ERR(svn_stream_printf_from_utf8(dwi->outstream,
-                  dwi->header_encoding, scratch_pool,
+        SVN_ERR(svn_stream_printf_from_utf8(diff_cmd_baton->outstream,
+                  diff_cmd_baton->header_encoding, scratch_pool,
                   "Index: %s (deleted)" APR_EOL_STR
                   SVN_DIFF__EQUAL_STRING APR_EOL_STR,
                   index_path));
